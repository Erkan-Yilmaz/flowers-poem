<!DOCTYPE html>
<html ng-app="flowers">
<head>
</head>
<body>

  <div id="field"></div>
  
  <script type="text/javascript" src="tools/d3/d3.min.js"></script>
  <script type="text/javascript">

  var field, flowers, w, h, d, n, dx, color, touching;
  color = false;
  w = 960;
  h = 600;
  d = 9;
  n = 19;
  dx = Math.min(w / (n + .5), h / (d + .5));
  w = dx * (n + .5);
  h = dx * (d + .5);

  // Preparing the field
  field =
    d3.select("#field")
    .append("svg")
    .attr("width", w)
    .attr("height", h)
    .on('mouseover', function(d, i) {
      if (color === false) {
        d3.selectAll("path")
          .transition()
          .duration(1000)
          .style("stroke", function(d, i) {
            // Finding the most beautiful colors
            return beautiful_color();
        });
        color = true;
      }
    })

  // Grow flowers
  flowers =
    field.selectAll("g")
    .data(d3.range(d * n).map(function(i) { return [1 + i % n, 1 + ~~(i / n)]; }))
    .enter()
    .append("g")
    .attr("transform", function(d, i) { return "translate(" + [d[0] * dx, d[1] * dx] + ")"; });

  flowers
    .append("path")
    .on("mouseover", start_touching)
    .on("mouseout", stop_touching)
    .style("stroke", "#000");

  function beautiful_color() {
    var dark = 120, light = 150, color, rgb, r, g, b;

    for (var i=0; i < 20; i++) {
      color = ('ffffff' + Math.floor(Math.random() * 0xFFFFFF)
        .toString(16))
        .substr(-6);

      rgb = parseInt(color, 16);

      vector = {
        r:(rgb >> 16) & 0xff,
        g: (rgb >>  8) & 0xff,
        b: (rgb >>  0) & 0xff
      };

      luminosity = 0.2126 * vector.r + 0.7152 * vector.g + 0.0722 * vector.b; // per ITU-R BT.709

      if (luminosity > dark && luminosity < light)
        return "#"+color;
    }
    return "#"+color;
  }
  function start_touching(d, i) {
    var flower = d3.select(this);
    flower
     .transition()
     .delay(10)
     .duration(1000)
     .attr("d", handcraft_flower)
     .style("stroke", "#ccc");
  }
  function stop_touching(d, i) {
    // Please touch me again
  }
  </script>
</body>
</html>